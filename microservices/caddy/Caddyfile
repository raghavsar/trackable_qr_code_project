{
    # Global options
    debug
    log {
        output file /data/access.log {
            roll_size 10MB
            roll_keep 10
            roll_keep_for 168h
        }
        format json
        level INFO
    }
}

qr.phonon.io {
    # Use a self-signed certificate for now
    tls internal

    # Enable HTTP compression
    encode gzip zstd

    # Handle ACME challenge requests for Let's Encrypt SSL
    handle /.well-known/acme-challenge/* {
        respond 200
    }

    # Handle requests starting with /api/
    # Proxy them to the api-gateway service on port 8000
    handle_path /api/* {
        reverse_proxy api-gateway:8000 {
            # Trust private networks and Cloudflare IPs
            trusted_proxies private_ranges
            
            # Only forward essential headers
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            
            # Transport configuration
            transport http {
                tls_insecure_skip_verify
            }
        }
    }

    # TODO: Add a 'handle' block here if you also want Caddy
    # to serve your frontend application from the same domain.
    # Example:
    # handle {
    #     root * /path/to/your/frontend/build
    #     file_server
    #     try_files {path} /index.html
    # }

    # Logging for this specific site
    log {
        output file /data/qr.phonon.io.log {
            roll_size 10MB
            roll_keep 10
            roll_keep_for 168h
        }
        format json
        level DEBUG # More detailed logging for debugging
    }
} 