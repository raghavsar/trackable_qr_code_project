{
	# Global options
	debug

	log {
		output file /data/access.log {
			roll_size 10MB
			roll_keep 10
			roll_keep_for 168h
		}
		format json
		level INFO
	}
}

qr.phonon.io {
	# Use the provided certificate and key
	tls /etc/caddy/certs/qr.phonon.io.crt /etc/caddy/certs/qr.phonon.io.key

	# Enable HTTP compression
	encode gzip zstd

	# Handle ACME challenge requests for Let's Encrypt SSL
	handle /.well-known/acme-challenge/* {
		respond "OK" 200
	}

	# Handle requests starting with /api/
	handle_path /api/* {
		# Proxy to the API gateway using plain HTTP within the Docker network
		reverse_proxy http://api-gateway:8000 {
			trusted_proxies private_ranges

			header_up Host {host}
			header_up X-Real-IP {remote_host}
		}
	}

	# Handle MinIO requests
	handle_path /minio/* {
		reverse_proxy http://minio:9000 {
			trusted_proxies private_ranges
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-Proto {scheme}

			# Ensure proper path handling
			rewrite * /minio{path}

			# CORS headers for MinIO resources
			header_down Access-Control-Allow-Origin "*"
			header_down Access-Control-Allow-Methods "GET, POST, OPTIONS"
			header_down Access-Control-Allow-Headers "*"
			header_down Access-Control-Expose-Headers "ETag, X-Content-Type-Options, X-Amz-Request-Id"
			header_down X-Content-Type-Options "nosniff"
		}

		# Handle OPTIONS requests for CORS
		@options {
			method OPTIONS
		}
		respond @options 204
	}

	# Logging for this specific site
	log {
		output file /data/qr.phonon.io.log {
			roll_size 10MB
			roll_keep 10
			roll_keep_for 168h
		}
		format json
		level DEBUG
	}
}
